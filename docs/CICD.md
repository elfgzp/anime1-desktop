# CI/CD 架构文档

## 工作流概述

```
┌─────────────────────────────────────────────────────────────────┐
│                        GitHub Actions                           │
│                                                                 │
│  ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐      │
│  │  Push   │ or │   PR    │ or │   Tag   │ ──►│ Trigger │      │
│  │  main   │    │  main   │    │   v*    │    │ Workflow│      │
│  └─────────┘    └─────────┘    └─────────┘    └────┬────┘      │
│                                                     │           │
│                     ┌───────────────────────────────┘           │
│                     ▼                                           │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                        Test Job                         │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐  │   │
│  │  │ Checkout    │  │ Setup Node  │  │ Install Deps    │  │   │
│  │  │ Code        │─►│ 22.x        │─►│ npm ci          │  │   │
│  │  └─────────────┘  └─────────────┘  └────────┬────────┘  │   │
│  │                                              │           │   │
│  │           ┌──────────────────────────────────┘           │   │
│  │           ▼                                              │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐  │   │
│  │  │ Unit Tests  │  │ E2E Tests   │  │ ✅ Pass         │  │   │
│  │  │ vitest      │─►│ playwright  │─►│                 │  │   │
│  │  └─────────────┘  └─────────────┘  └─────────────────┘  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                     │                                           │
│                     ▼ (Tests Pass)                              │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                        Build Job                        │   │
│  │                    Matrix: [macOS, Linux, Windows]       │   │
│  │                                                         │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐  │   │
│  │  │ Checkout    │  │ Setup Node  │  │ Install Deps    │  │   │
│  │  │ Code        │─►│ 22.x        │─►│ npm ci          │  │   │
│  │  └─────────────┘  └─────────────┘  └────────┬────────┘  │   │
│  │                                              │           │   │
│  │  ┌───────────────────────────────────────────┘           │   │
│  │  ▼                                                      │   │
│  │  ┌─────────────────────────────────────────────────┐    │   │
│  │  │              Code Signing (Optional)             │    │   │
│  │  │  ┌─────────────┐        ┌─────────────┐         │    │   │
│  │  │  │ macOS       │        │ Windows     │         │    │   │
│  │  │  │ DeveloperID │        │ Cert/PFX    │         │    │   │
│  │  │  │ +Notarize   │        │             │         │    │   │
│  │  │  └─────────────┘        └─────────────┘         │    │   │
│  │  └─────────────────────────────────────────────────┘    │   │
│  │                          │                              │   │
│  │                          ▼                              │   │
│  │  ┌─────────────────────────────────────────────────┐    │   │
│  │  │                   Build                          │    │   │
│  │  │  ┌─────────────┐  ┌─────────────┐              │    │   │
│  │  │  │ npm run     │  │ Platform    │              │    │   │
│  │  │  │    make     │─►│ Specific    │              │    │   │
│  │  │  │             │  │ Outputs     │              │    │   │
│  │  │  └─────────────┘  └──────┬──────┘              │    │   │
│  │  │                          │                     │    │   │
│  │  │  ┌───────────────────────┴──────────────────┐  │    │   │
│  │  │  │ macOS: .zip                                 │  │    │   │
│  │  │  │ Linux: .deb, .rpm                           │  │    │   │
│  │  │  │ Windows: .exe (Squirrel)                    │  │    │   │
│  │  │  └─────────────────────────────────────────────┘  │    │   │
│  │  └─────────────────────────────────────────────────┘    │   │
│  │                          │                              │   │
│  │                          ▼                              │   │
│  │  ┌─────────────────────────────────────────────────┐    │   │
│  │  │                   Publish                        │    │   │
│  │  │  (Only on Tag)                                   │    │   │
│  │  │  ┌─────────────┐  ┌─────────────────────────┐   │    │   │
│  │  │  │ GitHub      │  │ Release Notes           │   │    │   │
│  │  │  │ Releases    │◄─│ Auto-generated          │   │    │   │
│  │  │  │             │  │ from commits            │   │    │   │
│  │  │  └─────────────┘  └─────────────────────────┘   │    │   │
│  │  └─────────────────────────────────────────────────┘    │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 自动更新流程

```
┌─────────────┐         ┌─────────────┐         ┌─────────────────┐
│   Client    │         │   Server    │         │   GitHub        │
│   (App)     │         │   (Proxy)   │         │   Releases      │
└──────┬──────┘         └──────┬──────┘         └────────┬────────┘
       │                       │                         │
       │  1. Check for Update  │                         │
       │  electron-updater     │                         │
       │                       │  2. Query Latest        │
       │                       │     Release             │
       │                       │────────────────────────►│
       │                       │                         │
       │                       │◄────────────────────────│
       │                       │  3. Release Info        │
       │◄──────────────────────│                         │
       │  4. Update Available  │                         │
       │     { version, url }  │                         │
       │                       │                         │
       │  5. Download Update   │                         │
       │────────────────────────────────────────────────►│
       │                       │                         │
       │◄────────────────────────────────────────────────│
       │  6. Download Complete │                         │
       │                       │                         │
       │  7. Install on Quit   │                         │
       │     or Restart Now    │                         │
       │                       │                         │
```

## 安全机制

### 代码签名流程

```
Build ──► Sign ──► Notarize (macOS) ──► Distribute
            │           │
            │           ▼
            │    ┌─────────────┐
            │    │ Apple       │
            │    │ Notary      │
            │    │ Service     │
            │    └─────────────┘
            ▼
    ┌───────────────┐    ┌───────────────┐
    │ Developer ID  │ or │ Windows       │
    │ Certificate   │    │ Code Signing  │
    │ (Apple)       │    │ Certificate   │
    └───────────────┘    └───────────────┘

User Install ──► OS Verifies Signature ──► ✅ Run
```

### ASAR 完整性保护

```
Source Code ──► ASAR Archive ──► Fuse Protection
                                  ├─ OnlyLoadAppFromAsar
                                  └─ ASAR Integrity Validation
```

## 文件结构

```
.github/
└── workflows/
    ├── build.yml          # 主 CI/CD 工作流
    └── README.md          # 工作流文档

assets/
├── icon.ico               # Windows 图标
├── icon.icns              # macOS 图标
├── icon.png               # Linux 图标
├── installer.gif          # Windows 安装动画
└── README.md              # 资源说明

src/
└── services/
    └── updater.js         # 自动更新服务

forge.config.js            # Electron Forge 配置
entitlements.plist         # macOS 签名权限
BUILD.md                   # 构建指南
BUILD_CHECKLIST.md         # 设置检查清单
```

## 监控与日志

### GitHub Actions 日志

- 每个 workflow run 都有详细日志
- 可以实时查看构建进度
- 失败时会有错误详情

### 应用日志位置

- **macOS**: `~/Library/Logs/Anime1Desktop/`
- **Windows**: `%APPDATA%\Anime1Desktop\logs\`
- **Linux**: `~/.config/Anime1Desktop/logs/`
