name: Test and Coverage

# 运行单元测试，生成覆盖率报告，PR 时评论覆盖率

on:
  push:
    branches:
      - main
      - master
    paths:
      - '**.py'
      - 'pyproject.toml'
      - 'Makefile'
      - '.github/workflows/test-ci.yml'
  pull_request:
    branches:
      - main
      - master
    paths:
      - '**.py'
      - 'pyproject.toml'
      - 'Makefile'
      - '.github/workflows/test-ci.yml'

env:
  PYTHON_VERSION: '3.11'

jobs:
  test-linux:
    name: Run unit tests (Linux)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install pytest pytest-cov coverage

      - name: Run unit tests with coverage
        id: test
        run: |
          pytest tests/ -v -m unit --tb=short --cov=src --cov-report=xml --cov-report=term-missing

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage.xml
          retention-days: 7

      - name: Coverage comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const coverage = fs.readFileSync('coverage.xml', 'utf8');

            // Extract coverage percentage
            const lineRateMatch = coverage.match(/line-rate="([0-9.]+)"/);
            const lineRate = lineRateMatch ? parseFloat(lineRateMatch[1]) * 100 : 0;

            const branchRateMatch = coverage.match(/branch-rate="([0-9.]+)"/);
            const branchRate = branchRateMatch ? parseFloat(branchRateMatch[1]) * 100 : 0;

            const coverageText = `## Test Coverage\n\n| Type | Coverage |\n|------|----------|\n| Lines | ${lineRate.toFixed(1)}% |\n| Branches | ${branchRate.toFixed(1)}% |`;

            // Get the PR number
            const prNumber = context.issue.number;

            // Create or update comment
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: coverageText + '\n\n_Unit tests passed: ' + (process.exitCode === 0 ? 'Yes' : 'No') + '_'
            });

      - name: Check if tests passed
        run: |
          if [ ${{ steps.test.outcome }} == 'failure' ]; then
            echo "Tests failed!"
            exit 1
          fi
          echo "Tests passed!"

  test-windows:
    name: Run unit tests (Windows)
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install pytest pytest-cov coverage

      - name: Run unit tests
        id: test
        run: |
          pytest tests/ -v -m unit --tb=short

  test-macos:
    name: Run unit tests (macOS)
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install pytest pytest-cov coverage

      - name: Run unit tests
        id: test
        run: |
          pytest tests/ -v -m unit --tb=short

  test-report:
    name: Generate coverage summary
    runs-on: ubuntu-latest
    needs: test-linux
    if: github.event_name != 'pull_request'
    steps:
      - name: Download coverage report
        uses: actions/download-artifact@v4
        with:
          name: coverage-report
          path: .

      - name: Coverage summary
        run: |
          echo "## Unit Test Results"
          echo ""
          echo "✅ All unit tests passed (Linux, Windows, macOS)"
          echo ""
          echo "Coverage report generated: coverage.xml"
          echo ""
          echo "To view detailed coverage report, download the artifact."
